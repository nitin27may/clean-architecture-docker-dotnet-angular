<div class="container mx-auto p-4">
  <div class="max-w-6xl mx-auto">
    <!-- Page Header -->
    <app-page-header
      title="User Roles Management"
      subtitle="Assign and manage roles for system users"
      icon="admin_panel_settings">
    </app-page-header>
    
    <!-- Assignment Form Card -->
    <mat-card class="mb-6 overflow-hidden">
      <div class="bg-surface-container-high px-6 py-4 border-b border-outline-variant">
        <h2 class="text-lg font-semibold m-0 flex items-center gap-2">
          <mat-icon class="text-primary">assignment_ind</mat-icon>
          Assign Roles to User
        </h2>
      </div>
      
      <mat-card-content style="padding: 0;">
        <div class="p-6 pt-8">
          <form [formGroup]="userRoleForm" (ngSubmit)="saveUserRoles()" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Select User</mat-label>
                <mat-select formControlName="userId" (selectionChange)="onUserChange($event.value)">
                  @if (loading()) {
                    <mat-option disabled>Loading users...</mat-option>
                  } @else if (users().length === 0) {
                    <mat-option disabled>No users available</mat-option>
                  } @else {
                    @for (user of users(); track user.id) {
                      <mat-option [value]="user.id">
                        {{ user.firstName }} {{ user.lastName }} ({{ user.email }})
                      </mat-option>
                    }
                  }
                </mat-select>
                @if (userRoleForm.get('userId')?.hasError('required') && userRoleForm.get('userId')?.touched) {
                  <mat-error>User is required</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Assign Roles</mat-label>
                <mat-select formControlName="roleIds" multiple>
                  @if (loadingRoles()) {
                    <mat-option disabled>Loading roles...</mat-option>
                  } @else if (roles().length === 0) {
                    <mat-option disabled>No roles available</mat-option>
                  } @else {
                    @for (role of roles(); track role.id) {
                      <mat-option [value]="role.id">{{ role.name }}</mat-option>
                    }
                  }
                </mat-select>
                @if (userRoleForm.get('roleIds')?.hasError('required') && userRoleForm.get('roleIds')?.touched) {
                  <mat-error>At least one role is required</mat-error>
                }
              </mat-form-field>
            </div>
            
            <div class="flex justify-end gap-3 pt-4 border-t border-outline-variant">
              <button mat-flat-button color="primary" type="submit" [disabled]="userRoleForm.invalid || loading()">
                @if (loading()) {
                  <mat-spinner diameter="20" class="inline-block mr-2"></mat-spinner>
                }
                Save User Roles
              </button>
            </div>
          </form>
        </div>
      </mat-card-content>
    </mat-card>
    
    <!-- User Details Card -->
    <mat-card class="overflow-hidden">
      <div class="bg-surface-container-high px-6 py-4 border-b border-outline-variant">
        <h2 class="text-lg font-semibold m-0 flex items-center gap-2">
          <mat-icon class="text-primary">person</mat-icon>
          User Details
        </h2>
      </div>
      
      <mat-card-content class="p-6">
        @if (loading() || loadingRoles()) {
          <app-skeleton type="details" />
        } @else if (selectedUser()) {
          <div class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <p class="text-sm text-on-surface-variant mb-1">Name</p>
              <p class="font-medium">{{ selectedUser()?.firstName }} {{ selectedUser()?.lastName }}</p>
            </div>
            <div>
              <p class="text-sm text-on-surface-variant mb-1">Email</p>
              <p class="font-medium">{{ selectedUser()?.email }}</p>
            </div>
            <div>
              <p class="text-sm text-on-surface-variant mb-1">Username</p>
              <p class="font-medium">{{ selectedUser()?.userName }}</p>
            </div>
          </div>
          
          <div class="pt-4 border-t border-outline-variant">
            <h3 class="text-base font-semibold mb-3 flex items-center gap-2">
              <mat-icon class="text-primary">badge</mat-icon>
              Current Roles
            </h3>
            
            @if (selectedRoles().length > 0) {
              <div class="flex flex-wrap gap-2">
                @for (roleId of selectedRoles(); track roleId) {
                  <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-primary/10 text-primary">
                    {{ getRoleName(roleId) }}
                  </span>
                }
              </div>
            } @else {
              <p class="text-on-surface-variant">No roles assigned</p>
            }
          </div>
        } @else {
          <app-empty-state
            icon="person_search"
            title="No user selected"
            description="Please select a user from the dropdown above to view their details and assigned roles.">
          </app-empty-state>
        }
      </mat-card-content>
    </mat-card>
  </div>
</div>
